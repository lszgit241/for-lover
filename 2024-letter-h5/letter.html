<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>For Dandan!</title>
  </head>
  <body>
    <style>
      :root {
        --text-white: #ffeafe;
        --text-normal-size: 4.2vw;
        --text-title-size: 5.6vw;
        --content-padding: 4vw;
      }
      .f {
        font-family: Microsoft YaHei, PingFang SC;
        color: var(--text-white);
        font-weight: 100;
        opacity: 0.96;
        letter-spacing: 1px;
      }
      .f-center {
        text-align: center;
      }
      .f-bold {
        font-weight: 400;
      }
      .f-height {
        line-height: 3 !important;
      }
      .f-title {
        font-size: var(--text-title-size);
        line-height: 2;
        padding: 0 var(--content-padding);
        padding-top: 1.5vw;
        box-sizing: border-box;
      }
      .f-normal {
        font-size: var(--text-normal-size);
        line-height: 1.6;
        padding: 0 var(--content-padding);
        padding-top: 1.5vw;
        box-sizing: border-box;
      }
      .l-w-p100 {
        width: 100%;
      }
      .l-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      .l-align-center {
        display: block;
        margin: 0 auto;
      }
      .input {
        border: 0;
        background-color: transparent;
        outline: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.5);
      }
      .image {
        display: block;
        width: 80vw;
        height: auto;
        border-radius: 2vw;
        box-shadow: 0 0 1vw 1vw rgba(0, 0, 0, 0.16);
        box-sizing: border-box;
        animation: showUp 1s linear forwards;
      }
      .i-content {
        margin: 1.5vw var(--content-padding);
      }
      .blink {
        animation: blink 1s linear infinite;
      }
      .weak-blink {
        animation: weakBlink 4s linear infinite;
      }
      @keyframes showUp {
        0% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }
      @keyframes blink {
        0% {
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }
      @keyframes weakBlink {
        0% {
          opacity: 0.3;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.3;
        }
      }
    </style>
    <style>
      html,
      body {
        width: 100vw;
        height: 100vh;
        margin: 0;
        padding: 0;
        font-size: 0;
        background: linear-gradient(120deg, #360033 30%, #042033);
      }
      .stage {
        width: 100vw;
        height: calc(100vh - 18vw);
        overflow: scroll;
        box-sizing: border-box;
      }
      .stage::-webkit-scrollbar {
        display: none;
      }
      .stage::-moz-scrollbar {
        display: none;
      }
      .stage::-o-scrollbar {
        display: none;
      }
      .stage::-ms-scrollbar {
        display: none;
      }
      .stage-footer {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        transition: 0.3s all ease-in-out;
        opacity: 0;
        pointer-events: none;
      }
      .footer-show {
        opacity: 1;
        pointer-events: auto;
      }
      .temps {
        display: none;
        width: 0;
        height: 0;
      }
    </style>
    <!-- 主要舞台 -->
    <div id="stage" class="stage"></div>
    <div id="stageFooter" class="stage-footer">
      <div
        style="margin: 0 auto 2vw auto"
        class="f f-normal f-center f-height weak-blink"
        onclick="nextMessage()"
      >
        点我以继续阅读
      </div>
    </div>
    <!-- 临时存放的dom模板 -->
    <div class="temps"></div>
    <script>
      var IMAGE_MAP = {
        金顶喜马拉雅:
          'https://w2-risk-fe.kwimgs.com/kos/nlav111581/9b3e237f7da592aeab93c89affd9ec91.a7cdcd5f920289b8.jpg',
        尼泊尔河流和木船:
          'https://w2-risk-fe.kwimgs.com/kos/nlav111581/168efe3395936fb8e115e805406d0155.b5d32d3f1367ea7f.jpeg',
        雪顶喜玛拉雅:
          'https://w2-risk-fe.kwimgs.com/kos/nlav111581/0900ca411c546900ff6b260131b0e83b.2268016fddba06ee.jpeg',
        尼泊尔寺庙:
          'https://w2-risk-fe.kwimgs.com/kos/nlav111581/8a68d6cc5532af612a5684e916376aa4.bff10ea883292d23.jpeg',
      };
      var fullScreenFlag = false;
      var CENTER_TITLE_PATTERN = 'f f-title l-center l-w-p100 f-center';
      var TITLE_PATTERN = 'f f-title';
      var BOLD_TITLE_PATTERN = 'f f-title f-bold';
      var NORMAL_PATTERN = 'f f-normal';
      var CENTER_IMAGE_PATTERN = 'image l-center';
      var IMAGE_PATTERN = 'image i-content';
      var messageIndex = 0;
      var spellWordProcess = Promise.resolve();
      var isSpelling = false;
      var isImageLoading = false;
      var nextMessageProcessing = false;
      var bgMusic = null;
      // 整个信件的文字结构信息
      var LETTER_MESSAGES = [
        [
          $center_title('点我开始阅读这封信', {
            onClick: [
              'enterFullscreen',
              'showFooter',
              'playDefaultMusic',
              'nextMessage',
            ],
          }),
        ],
        [
          // letter start
          $center_title('Hi 丹丹!'),
        ],
        [
          $center_title(
            '我是脏脏！哈哈，思来想去，还是想用这样的一封信祝你生日快乐！'
          ),
        ],
        [
          $center_title(
            '这是一封还挺长的信，请提前找个舒服的姿势，慢慢的看：）'
          ),
        ],
        [
          // 正文开始
          $center_title('首先...'),
        ],
        [
          // 信的正文
          $bold_title('第一章 开始'),
          $title('我们一切的开始 —— 大学'),
          $text(
            '2021年初，我们相识在大学的艺术团纳新活动上，那时的我，尚且懵懂无知，而你也仍有一段还未割舍的感情，所以我们虽相逢，但命运并没有因此擦出什么火花，时光仍旧一如既往的向前进行，日子仍旧是平凡的日子'
          ),
          $text(
            '但有幸的是，我们彼此都发现了一个重要的共同点，就是我们都很爱写东西，那个时候QQ空间还很流行，我看了你写的很多文章，虽已记不清具体的内容，但是也许就是从那个时候吧，至少在我这里，那时候就已经种下了一个小小的种子，一个“你对我来说有一些特别”的小小种子...'
          ),
          $text(
            '所以有的时候我会偶尔QQ联系你，一起聊一些“抽象哲学”的话题，来验证你在我心中的位置，当然了事后想想其实你也不擅长这个，所以也不知当时是怎么验证出来的，哈哈：）'
          ),
          $text(
            '那时也会偷偷的看你QQ空间里的照片，去脑补你是一个怎么样的人，那时候的你在我眼中，亲切热情，你简单干净，直面镜头的照片，也对我有着一种直接而又自然的引力，让我自然而然的想起你，我太确定那种感觉是什么，但这对于一个看待世界小心翼翼的我来说，是一份非常独特的吸引力'
          ),
          $text(
            '但我们交谈的不多，可能是因为当时的我，自己的心中还有太多的疑惑和问题要解决吧，也可能是因为那时的我是懵懂的，不知道心中的那个感觉是什么：）'
          ),
          $text(
            '至此，我们的相识就是如此平淡，甚至这一切都只是我的心理活动，这个开始，平淡到甚至像是地球上任何两个普通人的相识...'
          ),
        ],
        [
          // 第二章
          $center_title('后来...'),
        ],
        [
          $bold_title('第二章 静止'),
          $title('短暂而漫长的暂停 —— 新的“他”'),
          $text(
            '从”只有我们两个人“的宇宙这个维度来讲，这段时间其实是静止的，因为大学里，你“新的他”出现了，他陪你走过了很长很长的时间，久到我已记忆模糊...'
          ),
          $text(
            '这段时间我，也刻意的对你没有任何打扰，只是从QQ空间中会偶然会获得一些新的关于你的小故事...'
          ),
          $text('但其实刚得知这个消息的时候，我是稍有情绪萦绕心中的'),
          $text(
            '可十分抱歉，那时候的我，局促与焦虑缠身，甚至有着重度的抑郁和轻生想法，并无暇认真的去顾及这份感受，当然了，还有一份更重要的情绪是...'
          ),
          $text(
            '希望你能幸福，是真诚的祝你幸福，祝当时的你能更加幸福，因为我记得我那时已经大概知晓了你入学前的那个男朋友的那段故事，我觉得”新的他“总归是更好的，哪怕相较于当时的我而言，也是更好的'
          ),
          $text(
            '那段时间，艺术团的复杂人际交往与积压过多的学分压力足以让我崩溃与厌世，我找不到我存在的意义，终日都在无尽的痛苦与巨大的压力中度过，后来你离开了艺术团，而我又在那个让我温暖而又痛苦的地方呆了两年，温暖是因为涛哥和莹姐，他们始终在鼓励我，而痛苦，是因为艺术团里剩下的一切糟心事...'
          ),
          $text(
            '有幸那个时候的我，出于对痛苦的逃避，爱上了玩电脑游戏，并且也在“龙之谷”这个游戏里找到了一个十分重要的情感寄托，虽然这个网恋的“女朋友”最后无疾而终，但我觉得，这对于现在的我和我们，都有非常重要的意义'
          ),
          $text('因为从这段时间里，我深刻的学到了两件事情：'),
          $text('一、钱真的很重要；二、我学会了隐忍与思考；'),
          $text(
            '我深深的记得当时身上，连一百块都没有，那时的我是多么幼稚的等她来找我，幸好事实并没有发生，这使得我也不用辜负这段青涩的回忆'
          ),
          $text(
            '我也深深的记得，为了想通身边所发生的一切，我经历过多少个彻夜不眠的分析与思考，让我以这种扭曲的方式强行和这个世界进行了一次又一次的同步'
          ),
          $text(
            '那时候的我们，故事正在以平行时空的方式推移，一切看起来似乎不太会相交'
          ),
          $text('这就是静止的这段时间里，我们两人的一些细微变化...'),
        ],
        [
          // 第三章
          $center_title('接着...', {
            onEnter: ['playHopeMusic'],
          }),
        ],
        [
          $bold_title('第三章 涅槃'),
          $title('你与我的应许之地 —— 北京'),
          $text(
            '北京这个地方，对你我而言，即便用词“涅槃”，我觉得都再贴切不过，因为到目前为止所有重要的转折，都是因它而起'
          ),
          $text(
            '而且打破此前“静止”的平行时空的一切，似乎都是围绕着它发生的，而且我至今也有着强烈的预感，此后的故事，也一定会围绕着这个城市的去留而继续发生'
          ),
          $text(
            '我记得一切的交汇，都是从一个去北京前、微醺的深夜开始的，我记得那时的我是第一次告诉你我即将去北京的决定'
          ),
          $text(
            '那时的我，终于突破了迷茫与桎梏，具备了踏上未来征程的必备素质，当然我还是会迷失或无助，但我找到了克服的办法 —— 那就是勇往直前，哪怕至今我也仍旧相信，任何问题都可以通过行动与心态来解决，除非我的精神不再'
          ),
          $text(
            '而那时的你，也恰好碰到与“新的他”的关系瓶颈，和旧城市种种的工作或生活桎梏而苦恼不已，我冒昧猜测，那时的你应该也因为我和北京这个地方，看到了共同的希望与光，随着后来对于北京各类经历的不断推移与交织，2018年8月25日，我们正式在一起了！'
          ),
          $text(
            '说来有趣，命运如此轻巧的就让我们两个因彼此的困境而连结到了一起，当然必须提到的还有，感谢你来北京前对我的信任与托付'
          ),
          $text(
            '虽然你口口声声都说这是为了摆脱原有的生活的选择，可我知道这样的决定绝非随意或轻巧，一定是你斟酌已久的答案，那时的我其实也早已暗中许诺，绝不会亏待你，当然更多的心理活动就不在这里赘述了：）'
          ),
          $text('言而总之，你我因为北京这个地方，开始相伴而行！'),
        ],
        [
          // 第四章
          $center_title('如今...'),
        ],
        [
          $bold_title('第四章 瓶颈'),
          $title('你我与“琐碎”间的战斗 —— 生活'),
          $text(
            '我怀揣着“涅槃”时的勇往直前一路披荆斩棘，凭借着像小说里一样的机遇与赌博，突破了北京”超一线”城市对劣等生的枷锁，一路经历了“不起眼、将就、受认可、有价值、挺优秀”等等的多个被他人评价的阶段'
          ),
          $text(
            '而更内向的你也在自己擅长的领域与社会价值之间找到了微妙而又协调的平衡点，成为了一个顶流自媒体账号的编剧，并且在一次次的文本输出里证明了自己在文字与内容方面的价值，不断的闪光'
          ),
          $text('但此时，反而”琐碎“的事情成为了我们最头疼的问题...'),
          $text(
            '曾经的无往不利似乎此时戛然而止，我们会因为各自生活习惯的差异而感到苦恼，彼此也发现了对方身上更多的问题，幻想、假设、憧憬等等主观观念此时也大多破灭，曾经不以为意的涓涓细流此时已经成长为一头洪水猛兽，仿佛随时将会击溃我们曾经构筑起的坚固桥梁'
          ),
          $text(
            '这非常微妙，看起来似乎是一个：理性去看我们无法为对方解决，而感性去看也错失最好解决机会的麻烦问题，以至于整个生活似乎都停摆了，进入了一种螺旋却又没有上升的真空漂流阶段，哪怕已经一两年过去了，我们还是会为了一件相似的事情而争吵'
          ),
          $text(
            '紧接着，我们原本擅长的事情也慢慢出现了瓶颈，比如我的职业危机、你的能力成长受限、或者我们共同的资产还远远不够应付理想生活状态等等的问题'
          ),
          $text(
            '至少到现在，我也没能想到更好的办法，所有事情都纠缠到了一起，似乎现在的现状，就是最糟糕的现状...'
          ),
        ],
        [
          // 第四章
          $center_title('不过...'),
        ],
        [
          $bold_title('第五章 希望'),
          $title('尝试打破“琐碎”的魔咒 —— 远眺'),
          $text(
            '我承认我们面对的问题很多很复杂，我暂时还没有想到什么好的办法去解决'
          ),
          $text(
            '不过其实，这封信同时也是生日礼物的重点并不是这个，我其实是想在这个被去年与明年“前后夹击”的你的生日上，用我们的故事作为主旋律，送给你这一份特殊的生日礼物！'
          ),
          $text(
            '感谢你送给我的超豪华外星人显示器，这是一份很贵重很用心的生日礼物，同时也给了我一个思考的契机，让我重新审视了生日礼物应该有的真正含义，所以改为送给你现在这一份礼物：）'
          ),
          $text(
            '除了这封信作为生日礼物以外，我还买了一份我们一起去尼泊尔的旅游套餐：）'
          ),
          $image(IMAGE_MAP.金顶喜马拉雅),
          $text(
            '因为我听说尼泊尔就在喜马拉雅山麓之下，是一个可以净化人心灵的地方，去过的人都可以经受一次沐浴和洗礼，我希望我们能从这次洗礼中体会到现在所不能体会到的宝贵经验，这也算是我为咱们两个的烦恼作出的一次不太一样的努力与尝试：）'
          ),
          $text('我真诚的希望咱们能够一切向好，突破一切烦恼～'),
          $text('当然这里也有你比较喜欢的宗教文化'),
          $image(IMAGE_MAP.尼泊尔寺庙),
          $text('还有可以给我们以思考的徒步旅行'),
          $image(IMAGE_MAP.尼泊尔河流和木船),
          $text('这就是我现在的想法，也是我在这一章最想表达的事情！'),
        ],
        [$center_image(IMAGE_MAP.雪顶喜玛拉雅)],
        [$center_title('希望你会喜欢这样的一份生日礼物：）')],
        [
          // 第四章
          $center_title('最后...', {
            onEnter: ['playBirthdayMusic'],
          }),
        ],
        [$center_title('祝你生日快乐：）')],
        [$center_title('另外还有一件非常非常重要的事情想问你...')],
        [$center_title('你愿意嫁给我吗？')],
        [
          $text('当然这不是正式的求婚啦，只是一个真诚的问询', {
            onEnter: ['hideFooter'],
          }),
          $text(
            '我想确定即便生活是如此不完美的前提下，你也想与我一起踏过泥泞，共同寻找生活的真谛...'
          ),
          $text(
            '你可以仔细思考，当你确定你真的同意的时候，就可以轻按下面的“我愿意”三个字，作为这份生日礼物的最后一个小环节：）'
          ),
          $center_title('我愿意', {
            onClick: ['playWeddingMusic', 'nextMessage'],
          }),
        ],
        [
          $center_title('我也愿意：）', {
            onEnter: ['showFooter'],
          }),
        ],
        [$center_title('预祝我们白头偕老，百年好合：）')],
      ];
      function $text(message, config = {}) {
        return {
          class: NORMAL_PATTERN,
          message,
          ...config,
        };
      }
      function $title(message, config = {}) {
        return {
          class: TITLE_PATTERN,
          message,
          ...config,
        };
      }
      function $bold_title(message, config = {}) {
        return {
          class: BOLD_TITLE_PATTERN,
          message,
          ...config,
        };
      }
      function $image(src, config = {}) {
        return {
          type: 'image',
          class: IMAGE_PATTERN,
          src,
          ...config,
        };
      }
      function $center_title(message, config = {}) {
        return {
          class: CENTER_TITLE_PATTERN,
          message,
          ...config,
        };
      }
      function $center_image(src, config = {}) {
        return {
          type: 'image',
          class: CENTER_IMAGE_PATTERN,
          src,
          ...config,
        };
      }
      async function nextMessage() {
        if (isSpelling) {
          return false;
        }
        if (isImageLoading) {
          return false;
        }
        if (nextMessageProcessing) {
          return false;
        }
        nextMessageProcessing = true;
        // 清空
        var stageDOM = document.getElementById('stage');
        stageDOM.innerHTML = '';

        // 处理每一页的信息
        var msgArr = LETTER_MESSAGES[messageIndex];
        for (var i = 0; i < msgArr.length; i++) {
          var eachMsg = msgArr[i];
          if (eachMsg.onEnter) {
            if (
              Object.prototype.toString.call(eachMsg.onEnter) !==
              '[object Array]'
            ) {
              eachMsg.onEnter = [eachMsg.onEnter];
            }
            eachMsg.onEnter.forEach((eachEnterName) => {
              window[eachEnterName]();
            });
          }
          if (!eachMsg.type || eachMsg.type === 'text') {
            eachMsgDOM = document.createElement('div');
            if (eachMsg.class) {
              eachMsgDOM.classList.add(...eachMsg.class.split(' '));
            }
            stageDOM.appendChild(eachMsgDOM);
            // 文字统一都是通过拼写得出来的
            await spellWordSync(eachMsgDOM, eachMsg.message, eachMsg.class);
          } else if (eachMsg.type === 'image') {
            eachMsgDOM = document.createElement('img');
            eachMsgDOM.src = eachMsg.src;
            if (eachMsg.class) {
              eachMsgDOM.classList.add(...eachMsg.class.split(' '));
            }
            await drawImageSync(eachMsgDOM);
          }
          if (eachMsg.onClick) {
            eachMsgDOM.addEventListener('click', () => {
              if (isSpelling) {
                return false;
              }
              if (
                Object.prototype.toString.call(eachMsg.onClick) !==
                '[object Array]'
              ) {
                eachMsg.onClick = [eachMsg.onClick];
              }
              eachMsg.onClick.forEach((eachClickName) => {
                window[eachClickName]();
              });
            });
          }
        }
        // msgArr.forEach((eachMsg) => {
        //   var eachMsgDOM;
        // });

        // 播放完毕后执行下标
        messageIndex++;
        if (!LETTER_MESSAGES[messageIndex]) {
          messageIndex = 0;
        }
        nextMessageProcessing = false;
      }
      function playDefaultMusic() {
        playTargetMusic(
          'https://w2-risk-fe.kwimgs.com/kos/nlav111581/5c8965fae3e3677203.e448ddabf64858a7.mp3'
        );
      }
      function playHopeMusic() {
        playTargetMusic(
          'https://w2-risk-fe.kwimgs.com/kos/nlav111581/5c8a22a3ecf2f91373.99ec0a17946395d2.mp3'
        );
      }
      function playBirthdayMusic() {
        playTargetMusic(
          'https://w2-risk-fe.kwimgs.com/kos/nlav111581/5c89a08f1317563084.3f08469253517eda.mp3'
        );
      }
      function playWeddingMusic() {
        playTargetMusic(
          'https://w2-risk-fe.kwimgs.com/kos/nlav111581/5c89a2ea52c814342.9cb3193419914cee.mp3'
        );
      }
      async function playTargetMusic(src) {
        if (bgMusic) {
          await new Promise((resolve) => {
            var fadeInterval = 100; // 定义每次减小音量的时间间隔
            var fade = 0.05; // 定义音量逐渐减小的速度
            var fadingTimer = setInterval(function () {
              if (bgMusic.volume > fade) {
                bgMusic.volume = (bgMusic.volume - fade).toFixed(2);
              } else {
                clearInterval(fadingTimer);
                bgMusic.pause();
                bgMusic.src = '';
                resolve();
              }
            }, fadeInterval);
          });
        }
        bgMusic = new Audio(); // 创建一个新的音频对象
        bgMusic.src = src;
        bgMusic.loop = -1;
        bgMusic.play();
      }
      function showFooter() {
        document.getElementById('stageFooter').classList.add('footer-show');
      }
      function hideFooter() {
        document.getElementById('stageFooter').classList.remove('footer-show');
      }
      async function drawImageSync(dom) {
        isImageLoading = true;
        return new Promise((resolve) => {
          var stageDOM = document.getElementById('stage');
          dom.onload = async () => {
            stageDOM.appendChild(dom);
            stageDOM.scrollTop = stageDOM.scrollHeight;
            // 最后一个字拼完以后稍作停留
            await new Promise((pResolve) => setTimeout(() => pResolve(), 400));
            isImageLoading = false;
            resolve();
          };
        });
      }
      // 根据调用顺序，依次的以一定速度打进去
      async function spellWordSync(dom, message, classNames) {
        // dom不要每一个div同时打字，而是根据阅读顺序的顺次打字
        spellWordProcess = spellWordProcess.then(
          () =>
            new Promise(async (resolve) => {
              var stageDOM = document.getElementById('stage');
              isSpelling = true;
              // 增加文字块dom
              var textDOM = document.createElement('span');
              dom.appendChild(textDOM);

              // 增加光标dom
              var cursorDOM = document.createElement('span');
              cursorDOM.classList.add('f', 'blink');
              cursorDOM.innerHTML = ' |';
              dom.appendChild(cursorDOM);

              // 拼写文字
              for (var i = 0; i < message.length; i++) {
                // 输入字符时的间隔
                var randomPending = Math.random() * 300;
                await new Promise((pResolve) =>
                  setTimeout(() => pResolve(), randomPending)
                );
                var msgPart = message.slice(0, i + 1);
                textDOM.innerHTML = msgPart;

                // 拼写后自动聚焦到最后一行
                stageDOM.scrollTop = stageDOM.scrollHeight;
              }

              // 最后一个字拼完以后稍作停留
              await new Promise((pResolve) =>
                setTimeout(() => pResolve(), 800)
              );
              dom.removeChild(cursorDOM);
              isSpelling = false;
              resolve();
            })
        );
        return spellWordProcess;
      }

      // 进入全屏
      function enterFullscreen() {
        try {
          var element = document.documentElement;
          if (element.requestFullscreen) {
            element.requestFullscreen();
          } else if (element.msRequestFullscreen) {
            element.msRequestFullscreen();
          } else if (element.mozRequestFullScreen) {
            element.mozRequestFullScreen();
          } else if (element.webkitRequestFullscreen) {
            element.webkitRequestFullscreen();
          }
        } finally {
          fullScreenFlag = true;
        }
      }

      // 退出全屏
      function exitFullscreen() {
        try {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          }
        } finally {
          fullScreenFlag = false;
        }
      }

      window.onload = () => {
        nextMessage();
      };
    </script>
  </body>
</html>
